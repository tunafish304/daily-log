### Use SQLAlchemy ORM to Audit Foreign Key References
- To dry-run which users are still referenced in the message table:

```
from app import db
from app.models import Message

# Check which user IDs are still referenced
referenced_ids = db.session.query(Message.recipient_id)\
    .filter(Message.recipient_id.in_([1, 2, 3, 4]))\
    .distinct().all()

print("Referenced user IDs:", [r[0] for r in referenced_ids])
```

### Use SQLAlchemy Core for Raw SQL (if needed)
- If you want to run raw SQL inside your Flask shell:

```
from app import db

result = db.session.execute("""
    SELECT recipient_id, COUNT(*) AS message_count
    FROM message
    WHERE recipient_id IN (1, 2, 3, 4)
    GROUP BY recipient_id
""")

for row in result:
    print(row)
```

###
Reset and CRUD walkthrough
---

## Flask Shell: Reset and CRUD Walkthrough

This artifact models how to reset the database and perform CRUD operations on `User` and `Post` using SQLAlchemy ORM in the Flask shell.

### Setup

```bash
flask shell
```

**Inside the shell:**

```
from sqlalchemy import delete

for user in users:
    db.session.execute(delete(followers).where(followers.c.followed_id == user.id))
    db.session.execute(delete(followers).where(followers.c.follower_id == user.id))
    db.session.delete(user)

db.session.commit()
```
--------------------


### Delete All Users and Posts

```python
Post.query.delete()
User.query.delete()
db.session.commit()
```

- Dry-run safety tip_: Run `.all()` before and after to verify.

```python
User.query.all()  # Should be []
Post.query.all()  # Should be []
```

---
Great observation, David‚Äîand yes, you're touching on a subtle but important distinction in how SQLAlchemy models tables versus association tables.

---

### üß† Why `User.query.all()` Works but `followers.query.all()` Fails

- `User` is a **declared model class** in your `models.py`, so SQLAlchemy knows how to query it using the ORM.
- `followers`, on the other hand, is likely defined as a **raw `Table` object** using `db.Table(...)`‚Äînot as a full model class.

Because of that:
- `User.query.all()` works‚Äîit's using the ORM to query a mapped class.
- `followers.query.all()` fails‚Äîbecause `followers` isn‚Äôt a mapped class, and `.query` is only available on ORM models.

---

### ‚úÖ How to Query `followers` Safely

If you want to inspect the contents of the `followers` association table, use SQLAlchemy Core:

```python
from sqlalchemy import select
db.session.execute(select(followers)).fetchall()
```

Or, if you're just exploring in the shell:

```python
result = db.session.execute(select(followers))
for row in result:
    print(row)
```

---

### üß© Teaching Tip

This is a great moment to model:
- The difference between ORM models and raw tables
- How association tables are used in many-to-many relationships
- Why `.query` is tied to mapped classes, not `db.Table` objects

You got it, David‚Äîhere‚Äôs a clean, student-ready scaffold comparing ORM vs Core deletion strategies for many-to-many relationships:

---

## üß© Deleting from Association Tables: ORM vs Core

### ‚ùå What *Doesn't* Work

```python
Followers.query.filter_by(followed_id=user.id).delete()
```

This fails because `Followers` is a raw `Table`, not an ORM model. `.query` only works on mapped classes.

---

### ‚úÖ What *Does* Work (SQLAlchemy Core)

```python
from sqlalchemy import delete

db.session.execute(delete(followers).where(followers.c.followed_id == user.id))
db.session.execute(delete(followers).where(followers.c.follower_id == user.id))
db.session.delete(user)
db.session.commit()
```

- `followers.c.followed_id` accesses the column from the raw table
- `delete(followers)` builds a Core deletion statement
- `db.session.execute(...)` runs it safely

---

### üß† Teaching Tip

Use this to model:
- The difference between ORM models and raw tables
- How to safely delete from join tables
- Why `.query` is tied to mapped classes

---
### Create Users and Posts

```python
u1 = User(username='alice', email='alice@example.com')
u2 = User(username='bob', email='bob@example.com')
db.session.add_all([u1, u2])
db.session.commit()
```

```python
p1 = Post(body='Hello from Alice!', author=u1)
p2 = Post(body='Bob‚Äôs first post', author=u2)
db.session.add_all([p1, p2])
db.session.commit()
```

---

### Read and Loop

```python
User.query.all()
Post.query.all()
```

Loop through users and their posts:

```python
for user in User.query.all():
	print(user.username)
	for post in user.posts:
		print('  ‚Üí', post.body)
```

---

### ‚úèÔ∏è Update a User

```python
u = User.query.filter_by(username='alice').first()
u.email = 'newalice@example.com'
db.session.commit()
```

---

### Delete a User

```python
u = User.query.filter_by(username='bob').first()
db.session.delete(u)
db.session.commit()
```

---

### Recovery Modeling

If something breaks, rollback:

```python
db.session.rollback()
```

Use `.first()` or `.get(id)` to avoid `NoneType` errors:

```python
u = User.query.get(1)
if u:
	print(u.username)
```

---

